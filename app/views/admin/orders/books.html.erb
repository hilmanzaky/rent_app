<div  class="table_list">
  <table width="100%">
    <caption>Order</caption>
    <thead>
    <th>Nomor Order</th>
    <th>Nama dan Alamat</th>
    <% @products.each do |product| %>
      <th valign="bottom"><%= product.name.split(//).join('<br>').html_safe %></th>
    <% end %>
    </thead>
    <% @orders.each do |order| %>
      <tr>
        <td style="text-align: right"><%= order.id %></td>
        <td><%= order.customer %><br/><%= order.address %></td>
        <% 
           products = Product.find_by_sql("SELECT products.id, SUM(rented_qty) as rented_qty
                                           FROM products
                                                LEFT JOIN (SELECT product_id, rented_qty FROM rented_products
                                           WHERE order_id = #{order.id}) rp ON products.id = rp.product_id
                                           GROUP BY products.id, rented_qty ORDER BY products.name ASC")
        %>
        <% products.each do |product| %>
          <td><%= number_format(product.rented_qty) %></td>
        <% end %>
      </tr>
    <% end %>
  </table>
</div>